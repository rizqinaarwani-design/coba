<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Listening Peribahasa - MI NU Hidayatul Mubtadiin</title>
    <!-- Library untuk Export Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2e7d32;
            --secondary: #fbc02d;
            --danger: #d32f2f;
            --light: #f1f8e9;
            --white: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background: var(--white);
            width: 90%;
            max-width: 800px;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            margin: 20px;
        }

        .hidden { display: none; }

        /* UI Styling */
        h1 { color: var(--primary); margin-bottom: 5px; font-size: 2.2em; }
        h3 { color: #555; margin-top: 0; margin-bottom: 25px; }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.3s;
            margin: 5px;
            font-weight: bold;
        }

        .btn:hover { background: #1b5e20; transform: scale(1.05); }
        .btn-danger { background: var(--danger); }
        .btn-danger:hover { background: #b71c1c; }
        .btn-gray { background: #757575; }

        .form-group { text-align: left; margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }

        /* Audio Controls */
        .audio-box {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 1px solid #c8e6c9;
        }
        #audioSlider { width: 100%; margin: 15px 0; cursor: pointer; }

        /* Word Bank */
        .word-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 25px;
            padding: 20px;
            background: #fff9c4;
            border: 2px dashed var(--secondary);
            border-radius: 15px;
        }
        .word-item {
            background: var(--white);
            padding: 10px 18px;
            border: 2px solid var(--secondary);
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 2px 2px 0px var(--secondary);
        }
        .word-item:active { transform: translateY(2px); box-shadow: none; }

        /* Cloze Text */
        .cloze-list { text-align: left; line-height: 2.8; font-size: 1.1em; }
        .input-gap {
            border-bottom: 2px solid var(--primary);
            border-top: none; border-left: none; border-right: none;
            width: 110px;
            text-align: center;
            font-weight: bold;
            color: #1b5e20;
            background: #f1f8e9;
            cursor: pointer;
            font-size: inherit;
        }

        /* Results Table */
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background: var(--primary); color: white; }

        .card-info {
            background: #e3f2fd;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 8px solid #2196f3;
            text-align: left;
        }
    </style>
</head>
<body>

    <!-- AREA 1: COVER -->
    <div id="screen-cover" class="container">
        <div style="font-size: 50px;">üìö</div>
        <h1>BELAJAR PERIBAHASA</h1>
        <h3>MI NU HIDAYATUL MUBTADIIN UNDAAN KIDUL</h3>
        <p style="color: #666;">Didesain Oleh: Bapak Mohammad Arwani, S.Pd.I</p>
        <button class="btn" onclick="startApp()" style="padding: 20px 50px; font-size: 24px;">MULAI</button>
    </div>

    <!-- AREA 2: LOGIN -->
    <div id="screen-login" class="container hidden">
        <h2>Data Peserta Didik</h2>
        <hr>
        <div class="form-group">
            <label>Nama Lengkap:</label>
            <input type="text" id="userName" placeholder="Ketik nama lengkapmu...">
        </div>
        <div class="form-group">
            <label>Kelas:</label>
            <input type="text" id="userClass" value="6A" readonly style="background: #eee;">
        </div>
        <div class="form-group">
            <label>Nomor Absen:</label>
            <input type="number" id="userAbsen" placeholder="Ketik nomor absen...">
        </div>
        <button class="btn" onclick="goToGame()" style="width: 100%; margin-top: 10px;">Masuk ke Permainan</button>
    </div>

    <!-- AREA 3: GAME -->
    <div id="screen-game" class="container hidden">
        <h2 style="margin-bottom:0;">Mendengarkan Peribahasa</h2>
        <p>Gunakan tombol audio untuk membantu menjawab.</p>
        
        <div class="audio-box">
            <button class="btn" onclick="playAudio()">PLAY ‚ñ∂</button>
            <button class="btn btn-danger" onclick="pauseAudio()">PAUSE ‚è∏</button>
            <input type="range" id="audioSlider" min="0" max="100" value="0" step="1">
        </div>

        <p><strong>Pilih Kata:</strong> (Klik kata lalu kotak kosong akan terisi secara otomatis)</p>
        <div class="word-bank" id="wordBank"></div>

        <div class="cloze-list">
            1. Air beriak tanda tak <input type="text" class="input-gap" id="gap1" readonly onclick="clearGap(1)">. <br>
            2. Bagai air di daun <input type="text" class="input-gap" id="gap2" readonly onclick="clearGap(2)">. <br>
            3. Berat sama <input type="text" class="input-gap" id="gap3" readonly onclick="clearGap(3)">, ringan sama dijinjing. <br>
            4. Bagai <input type="text" class="input-gap" id="gap4" readonly onclick="clearGap(4)"> dibelah dua. <br>
            5. Sedikit demi sedikit, lama-lama menjadi <input type="text" class="input-gap" id="gap5" readonly onclick="clearGap(5)">. <br>
            6. Bagai <input type="text" class="input-gap" id="gap6" readonly onclick="clearGap(6)"> dalam tempurung. <br>
            7. Sekali merengkuh dayung, dua tiga <input type="text" class="input-gap" id="gap7" readonly onclick="clearGap(7)"> terlampaui. <br>
            8. Nasi sudah menjadi <input type="text" class="input-gap" id="gap8" readonly onclick="clearGap(8)">. <br>
            9. Rajin pangkal pandai, hemat pangkal <input type="text" class="input-gap" id="gap9" readonly onclick="clearGap(9)">. <br>
            10. Tak ada rotan, <input type="text" class="input-gap" id="gap10" readonly onclick="clearGap(10)"> pun jadi.
        </div>

        <button class="btn btn-danger" style="margin-top:40px; width: 100%;" onclick="submitGame()">SELESAI MENGERJAKAN</button>
    </div>

    <!-- AREA 4: HASIL & TABEL -->
    <div id="screen-result" class="container hidden">
        <h2 style="color: var(--primary);">Permainan Selesai!</h2>
        <div id="resultCard" class="card-info"></div>

        <div class="table-container">
            <h3>Daftar Nilai (Data Login)</h3>
            <table id="scoreTable">
                <thead>
                    <tr>
                        <th>ABSEN</th>
                        <th>NAMA</th>
                        <th>KELAS</th>
                        <th>NILAI</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div style="margin-top: 30px; display: flex; flex-wrap: wrap; justify-content: center;">
            <button class="btn" onclick="exportToExcel()" style="background: #2e7d32;">EXPORT EXCEL</button>
            <button class="btn btn-gray" onclick="resetGame()">ULANGI</button>
            <button class="btn btn-danger" onclick="finishAll()">SELESAI</button>
        </div>
    </div>

    <script>
        const correctAnswers = {
            1: "dalam", 2: "talas", 3: "dipikul", 4: "pinang", 5: "bukit",
            6: "katak", 7: "pulau", 8: "bubur", 9: "kaya", 10: "akar"
        };
        
        let words = Object.values(correctAnswers);
        let allScores = []; 
        let synth = window.speechSynthesis;
        let utterance;
        let isPaused = false;
        let progressInterval;

        // 1. Fungsi Start & TTS Awal
        function startApp() {
            document.getElementById('screen-cover').classList.add('hidden');
            document.getElementById('screen-login').classList.remove('hidden');
            
            let introText = "SELAMAT BELAJAR PERIBAHASA, DI DESAIN OLEH BAPAK MOHAMMAD ARWANI, SARJANA PENDIDIKAN ISLAM, YANG DIDESAIN KHUSUS UNTUK SISWA KELAS 6 A, MI NU HIDAYATUL MUBTADIIN, UNDAAN KIDUL, UNTUK MENGISI LIBURAN SEKOLAH, SEMOGA BERMANFAAT";
            speak(introText);
        }

        // 2. Fungsi Login
        function goToGame() {
            const name = document.getElementById('userName').value;
            const absen = document.getElementById('userAbsen').value;
            if(!name || !absen) return alert("Harap isi Nama dan Nomor Absen!");

            document.getElementById('screen-login').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');
            renderWordBank();
        }

        // 3. Fungsi Suara (TTS)
        function speak(text) {
            synth.cancel();
            utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'id-ID';
            utterance.rate = 0.85; // Sedikit lebih lambat agar jelas
            
            let voices = synth.getVoices();
            let indVoice = voices.find(v => v.lang.includes('id') || v.name.includes('Indonesian'));
            if(indVoice) utterance.voice = indVoice;

            synth.speak(utterance);
        }

        function playAudio() {
            if(isPaused) {
                synth.resume();
                isPaused = false;
            } else {
                let gameText = "Air beriak tanda tak dalam. Bagai air di daun talas. Berat sama dipikul ringan sama dijinjing. Bagai pinang dibelah dua. Sedikit demi sedikit, lama-lama menjadi bukit. Katak dalam tempurung. Sekali merengkuh dayung, dua tiga pulau terlampaui. Nasi sudah menjadi bubur. Rajin pangkal pandai, hemat pangkal kaya. Tak ada rotan, akar pun jadi. Ada udang di balik batu. Besar pasak daripada tiang. Bagaikan api dalam sekam. Buah jatuh tidak jauh dari pohonnya. Tong kosong nyaring bunyinya. Bagai mencari jarum dalam jerami. Malu bertanya sesat di jalan. menyelam minum air. Sepandai-pandai tupai melompat, akhirnya jatuh juga. Habis gelap terbitlah terang";
                speak(gameText);
                
                // Animasi Slider
                let slider = document.getElementById('audioSlider');
                slider.value = 0;
                clearInterval(progressInterval);
                progressInterval = setInterval(() => {
                    if(!synth.speaking) {
                        clearInterval(progressInterval);
                        slider.value = 100;
                    } else if(!isPaused) {
                        slider.value = parseFloat(slider.value) + 0.4;
                    }
                }, 500);
            }
        }

        function pauseAudio() {
            synth.pause();
            isPaused = true;
        }

        // 4. Word Bank Logic
        function renderWordBank() {
            const bank = document.getElementById('wordBank');
            bank.innerHTML = '';
            let shuffled = [...words].sort(() => Math.random() - 0.5);
            shuffled.forEach(w => {
                let div = document.createElement('div');
                div.className = 'word-item';
                div.innerText = w;
                div.onclick = () => fillGap(w);
                bank.appendChild(div);
            });
        }

        function fillGap(word) {
            for(let i=1; i<=10; i++) {
                let gap = document.getElementById('gap' + i);
                if(gap.value === "") {
                    gap.value = word;
                    break;
                }
            }
        }

        function clearGap(id) {
            document.getElementById('gap' + id).value = "";
        }

        // 5. Submit & Result
        function submitGame() {
            let score = 0;
            for(let i=1; i<=10; i++) {
                if(document.getElementById('gap' + i).value.toLowerCase() === correctAnswers[i]) {
                    score += 10;
                }
            }

            const name = document.getElementById('userName').value;
            const absen = document.getElementById('userAbsen').value;
            const kls = document.getElementById('userClass').value;

            // Simpan data
            allScores.push({ NOMOR_ABSEN: absen, NAMA: name, KELAS: kls, NILAI: score });

            document.getElementById('screen-game').classList.add('hidden');
            document.getElementById('screen-result').classList.remove('hidden');
            
            document.getElementById('resultCard').innerHTML = `
                <p><strong>Nama:</strong> ${name}</p>
                <p><strong>Nomor Absen:</strong> ${absen}</p>
                <p><strong>Kelas:</strong> ${kls}</p>
                <p style="font-size: 20px;"><strong>Skor Akhir:</strong> <span style="color:red; font-weight:bold; font-size: 30px;">${score}</span></p>
            `;

            updateTable();
            synth.cancel();
            clearInterval(progressInterval);
        }

        function updateTable() {
            const tbody = document.querySelector('#scoreTable tbody');
            tbody.innerHTML = '';
            // Urutkan berdasarkan nomor absen
            allScores.sort((a, b) => a.NOMOR_ABSEN - b.NOMOR_ABSEN);
            allScores.forEach(data => {
                let row = `<tr>
                    <td>${data.NOMOR_ABSEN}</td>
                    <td>${data.NAMA}</td>
                    <td>${data.KELAS}</td>
                    <td>${data.NILAI}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        function resetGame() {
            for(let i=1; i<=10; i++) document.getElementById('gap' + i).value = "";
            document.getElementById('audioSlider').value = 0;
            document.getElementById('screen-result').classList.add('hidden');
            document.getElementById('screen-login').classList.remove('hidden');
        }

        function finishAll() {
            if(confirm("Apakah Anda yakin ingin mengakhiri sesi belajar?")) {
                location.reload(); // Kembali ke halaman Cover
            }
        }

        // 6. Excel Export
        function exportToExcel() {
            if(allScores.length === 0) return alert("Belum ada data nilai!");
            const worksheet = XLSX.utils.json_to_sheet(allScores);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Hasil_Belajar");
            XLSX.writeFile(workbook, "Nilai_Peribahasa_6A.xlsx");
        }

        window.speechSynthesis.onvoiceschanged = () => { console.log("Voices Ready"); };
    </script>
</body>
</html>
